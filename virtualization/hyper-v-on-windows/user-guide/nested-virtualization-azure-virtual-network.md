---
title: Azure Virtual Network의 리소스와 직접 통신하도록 중첩된 VM 구성
description: 중첩된 가상화
keywords: windows 10, Hyper-V, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: 63007d21fcc046f384405c7d85143bfc576ecc07
ms.sourcegitcommit: 16ebc4f00773d809fae84845208bd1dcf08a889c
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/15/2020
ms.locfileid: "81395756"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Azure Virtual Network의 리소스와 통신하도록 중첩된 VM 구성

Azure 내에서 중첩된 가상 머신을 배포하고 구성하는 원래 지침을 따르려면 NAT 스위치를 통해 VM에 액세스해야 합니다. 여기에는 몇 가지 제한 사항이 있습니다.

1. 중첩된 VM은 온-프레미스 또는 Azure Virtual Network 내의 리소스에 액세스할 수 없습니다.
2. 온-프레미스 리소스나 Azure 내의 리소스는 NAT를 통해서만 중첩된 VM에 액세스할 수 있습니다. 즉, 여러 게스트가 동일한 포트를 공유할 수 없습니다.

이 문서에서는 RRAS, 사용자 정의 경로, 게스트 인터넷 액세스를 허용하는 아웃바운드 NAT 전용 서브넷 및 중첩된 VM이 Azure 내의 VNet에 직접 배포된 다른 가상 머신처럼 작동하고 통신할 수 있도록 하는 "부동" 주소 공간을 사용하는 배포 과정을 안내합니다.

이 가이드를 시작하기 전에:

1. 중첩 가상화에 대해 [여기에 제공된 지침](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization)을 읽어보세요.
2. 구현하기 전에 이 문서 전체를 읽어보세요.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>수행하는 작업과 이유에 대한 대략적인 개요
* NIC가 두 개 있는 중첩 가능 VM을 만듭니다. 
* NIC 하나는 중첩된 VM에 NAT를 통한 인터넷 액세스를 제공하는 데 사용되고, 다른 NIC는 내부 스위치에서 하이퍼바이저 외부의 리소스로 트래픽을 라우팅하는 데 사용됩니다. 각 NIC는 다른 라우팅 도메인 즉, 다른 서브넷에 있어야 합니다.
* 따라서 서브넷이 적어도 3개 이상 있는 Virtual Network가 필요합니다. 하나는 NAT용, 하나는 LAN 라우팅용, 하나는 사용되지 않지만 중첩된 VM에 대해 "예약된" 항목입니다. 이 문서에서 서브넷에 사용하는 이름은 "NAT", "Hyper-V-LAN" 및 "Ghosted"입니다.
* 이러한 서브넷의 크기는 자유 재량이지만 몇 가지 고려 사항이 있습니다. "Ghosted" 서브넷의 크기에 따라 중첩된 VM에 사용할 수 있는 IP 수가 결정됩니다. "NAT" 및 "Hyper-V-LAN" 서브넷의 크기에 따라 하이퍼바이저에 사용할 수 있는 IP 수가 결정됩니다. 따라서 하이퍼바이저를 하나 또는 두 개만 계획하는 경우 기술적으로 아주 작은 서브넷을 만들 수 있습니다.
* Background: 중첩된 VM은 내부 또는 외부 스위치를 구성하더라도 자체 호스트가 연결되어 있는 VNet에서 DHCP를 수신하지 않습니다. 
  * 따라서, Hyper-V 호스트가 DHCP를 제공해야 합니다.
* Hyper-V 호스트는 VNet에서 현재 할당된 임대를 인식하지 못합니다. 따라서 호스트가 이미 존재하는 IP를 할당하는 상황을 피하려면 Hyper-V 호스트만 사용할 IP 블록을 할당해야 합니다. 이렇게 하면 중복된 IP 시나리오를 방지할 수 있습니다.
  * 선택한 IP 블록은 Hyper-V가 있는 동일한 VNet 내 서브넷에 해당합니다.
  * 이렇게 기존 서브넷에 해당해야 하는 이유는 ExpressRoute를 통해 BGP 광고를 다시 처리하기 위해서 입니다. Hyper-V 호스트가 사용할 IP 범위를 구성했으면, 온-프레미스 클라이언트가 중첩된 VM과 통신할 수 있도록 일련의 고정 경로를 만들어야 합니다. 이것은 어려운 요구 사항이 아닙니다. 중첩된 VM의 IP 범위를 구성한 다음, 이 범위의 Hyper-V 호스트로 클라이언트를 안내하는 데 필요한 모든 경로를 생성해야 하기 때문입니다.
* Hyper-V 내에 내부 스위치를 만든 다음, 새로 만든 인터페이스에 DHCP를 위해 따로 설정한 범위 내의 IP 주소를 할당합니다. 이 IP 주소는 중첩된 VM의 기본 게이트웨이가 되며 VNet에 연결된 호스트의 NIC와 내부 스위치 간에 라우팅하는 데 사용됩니다.
* 호스트에 라우팅 및 원격 액세스 역할을 설치하면 호스트가 라우터로 전환됩니다.  이 작업은 호스트 외부의 리소스와 중첩된 VM 사이의 통신을 허용하는 데 필요합니다.
* 중첩된 VM에 액세스하는 방법을 다른 리소스에 알려줍니다. 이렇게 하려면 중첩된 VM이 상주하는 IP 범위에 대한 고정 경로가 포함된 사용자 정의 경로 테이블을 만들어야 합니다. 고정 경로는 Hyper-V의 IP 주소를 가리킵니다.
* 그런 다음, UDR을 게이트웨이 서브넷에 배치합니다. 그래야 온-프레미스에서 오는 클라이언트가 중첩된 VM에 도달하는 방법을 알 수 있습니다.
* 중첩된 VM에 연결해야 하는 Azure 내의 다른 서브넷에도 UDR을 배치합니다.
* 여러 Hyper-V 호스트의 경우 "부동" 서브넷을 추가로 만들고 UDR에 고정 경로를 더 추가합니다.
* Hyper-V 호스트의 서비스를 해제하는 경우, "부동" 서브넷을 삭제/용도 변경하고 고정 경로를 UDR에서 제거하거나 마지막 Hyper-V 호스트인 경우에는 UDR을 완전히 제거합니다.

## <a name="creating-the-host"></a>호스트 만들기

개인 취향에 따라 VM 이름, 리소스 그룹 등과 같은 구성 값을 지정합니다.

1. portal.azure.com으로 이동합니다.
2. 왼쪽 위에서 "리소스 만들기"를 클릭합니다.
3. Popular 열에서 "Window Server 2016 VM"을 선택합니다.
4. "기본" 탭에서 중첩된 가상화가 가능한 VM 크기를 선택해야 합니다.
5. "네트워킹" 탭으로 이동합니다.
6. 다음 구성으로 새 Virtual Network를 만듭니다.
    * VNet 주소 공간: 10.0.0.0/22
    * 서브넷 1
        * 이름: NAT
        * 주소 공간: 10.0.0.0/24
    * 서브넷 2
        * 이름: Hyper-V-LAN
        * 주소 공간: 10.0.1.0/24
    * 서브넷 3
        * 이름: Ghosted
        * 주소 공간: 10.0.2.0/24
    * 서브넷 4
        * 이름: Azure-VMs
        * 주소 공간: 10.0.3.0/24
7. VM의 NAT 서브넷을 선택했는지 확인합니다.
8. "리뷰 + 만들기"로 이동하여 "만들기"를 선택합니다.

## <a name="create-the-second-network-interface"></a>두 번째 네트워크 인터페이스 만들기
1. VM이 프로비저닝을 마친 후 Azure Portal 내에서 해당 항목으로 이동합니다.
2. VM을 중지합니다.
3. 중지되면 설정 아래 "네트워킹"으로 이동합니다.
4. "네트워크 인터페이스 연결"
5. "네트워크 인터페이스 만들기"
6. 이름을 지정합니다. (어떤 이름을 지정해도 상관없지만, 반드시 기억해야 합니다.)
7. 서브넷으로 "Hyper-V-LAN"을 선택합니다.
8. 호스트가 있는 동일한 리소스 그룹을 선택했는지 확인합니다.
9. "만들기"
10. 이전 화면이 열리면 새로 만든 네트워크 인터페이스를 선택하고 "확인"을 선택해야 합니다.
11. "개요" 창으로 돌아가서 이전 작업이 완료되면 VM을 다시 시작합니다.
12. 방금 만든 두 번째 NIC로 이동하면 이전에 선택한 리소스 그룹에서 찾을 수 있습니다.
13. "IP 구성"으로 이동하여 "IP 전달"을 "사용"으로 전환한 다음, 변경 내용을 저장합니다.

## <a name="setting-up-hyper-v"></a>Hyper-V 설정
1. 호스트에 원격으로 연결합니다.
2. 관리자 권한 PowerShell 프롬프트를 엽니다.
3. 다음 명령을 실행합니다. `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 호스트가 다시 시작됩니다.
5. 호스트에 다시 연결하여 나머지 설정을 계속합니다.

## <a name="creating-our-virtual-switch"></a>가상 스위치 만들기

1. 관리 모드에서 PowerShell을 엽니다.
2. 내부 스위치를 만듭니다. `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 새로 만든 인터페이스에 IP를 할당합니다. `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>DHCP 설치 및 구성

*중첩된 가상화 작업을 처음 시도하는 경우 이 구성 요소를 놓치는 경우가 많습니다. 게스트 VM이 호스트가 상주하는 네트워크에서 DHCP를 수신하는 온-프레미스와 달리, Azure의 중첩된 VM에는 VM이 실행되는 호스트를 통해 DHCP를 제공해야 합니다. 또는 모든 중첩된 VM마다 IP 주소를 정적으로 할당해야 하는데 이렇게 하면 확장성이 없습니다.*

1. DHCP 역할을 설치합니다. `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP 범위를 만듭니다. `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 범위에 대한 기본 게이트웨이 옵션 및 DNS를 구성합니다. `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 이름 확인이 작동하려면 올바른 DNS 서버를 입력해야 합니다. 이 경우 [Azure의 재귀 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)를 사용합니다.

## <a name="installing-remote-access"></a>원격 액세스 설치

1. 서버 관리자를 열고 "역할 및 기능 추가"를 선택합니다.
2. "서버 역할"이 나올 때까지 "다음"을 선택합니다.
3. "원격 액세스"를 선택하고 "역할 서비스"가 나올 때까지 "다음"을 클릭합니다.
4. "라우팅"을 선택하고 "기능 추가"를 선택한 다음, "다음"을 선택한 후 "설치"를 선택합니다. 마법사를 완료하고 설치가 완료될 때까지 기다립니다.

## <a name="configuring-remote-access"></a>원격 액세스 구성

1. 서버 관리자를 열고 "도구"를 선택한 다음, "라우팅 및 원격 액세스"를 선택합니다.
2. 라우팅 및 원격 액세스 관리 패널 왼쪽에 보이는 서버 이름 옆의 아이콘을 마우스 오른쪽 단추로 클릭하고 "라우팅 및 원격 액세스 구성 및 사용"을 선택합니다.
3. 마법사에서 "다음"을 선택하고 "사용자 지정 구성"을 선택한 후 "다음"을 선택합니다.
4. "NAT" 및 "LAN 라우팅"을 선택하고 "다음"을 선택한 다음, "마침"을 선택합니다. 서비스를 시작하라는 메시지가 표시되면 그렇게 합니다.
5. 이제 “IPv4” 노드로 이동하여 확장합니다. 그래야 “NAT” 노드를 사용할 수 있습니다.
6. "NAT"를 마우스 오른쪽 단추로 클릭하고 "새 인터페이스..."와 "이더넷"을 차례로 선택합니다. 이것이 IP가 "10.0.0.4"인 첫 번째 NIC입니다. "공용 인터페이스를 인터넷에 연결"과 "이 인터페이스에 NAT 사용"을 차례로 선택합니다. 
7. 이제 LAN 트래픽을 두 번째 NIC로 강제로 내보내도록 고정 경로를 만들어야 합니다. 이 작업은 "IPv4" 아래 "고정 경로" 노드로 이동하여 수행합니다.
8. 이 위치에 도착하면, 다음과 같은 경로를 만듭니다.
    * 경로 1
        * 인터페이스: 이더넷
        * 대상: 10.0.0.0
        * 네트워크 마스크: 255.255.255.0
        * 게이트웨이: 10.0.0.1
        * 메트릭: 256
        * 참고: 기본 NIC가 자체 인터페이스로 향하는 트래픽에 응답할 수 있도록 여기에 둡니다. 여기에 없으면 NIC 1로 가야 하는 트래픽이 다음 경로로 인해 NIC 2로 나가게 됩니다. 그러면 비대칭 경로가 만들어집니다. 10.0.0.1은 Azure가 NAT 서브넷에 할당하는 IP 주소입니다. Azure는 범위에서 첫 번째로 사용 가능한 IP를 기본 게이트웨이로 사용합니다. 따라서 NAT 서브넷에 192.168.0.0/24를 사용하기로 하면 게이트웨이는 192.168.0.1이 됩니다. 라우팅에서는 더 구체적인 경로가 우선합니다. 즉, 이 경로가 아래 경로보다 우선합니다.

    * 경로 2
        * 인터페이스: 이더넷 2
        * 대상: 10.0.0.0
        * 네트워크 마스크: 255.255.252.0
        * 게이트웨이: 10.0.1.1
        * 메트릭: 256
        * 참고: Azure VNet으로 향하는 트래픽의 포괄적인 경로이며, 트래픽을 두 번째 NIC로 강제로 보냅니다. 중첩된 VM이 액세스할 다른 범위에 대한 경로를 더 추가해야 합니다. 따라서 온-프레미스 네트워크가 172.16.0.0/22이면 해당 트래픽을 하이퍼바이저의 두 번째 NIC로 보낼 다른 경로가 필요합니다.

## <a name="creating-a-route-table-within-azure"></a>Azure 내에 경로 테이블 만들기

자세한 내용은 [이 문서를](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal) 참조하고 Azure 내에서 경로 만들기 및 관리는 아래를 계속 읽어보세요.

1. https://portal.azure.com 으로 이동합니다.
2. 왼쪽 위 모서리에서 "리소스 만들기"를 선택합니다.
3. 검색 필드에 "경로 테이블"을 입력하고 Enter 키를 누릅니다.
4. 최상위 결과인 경로 테이블을 선택한 다음, "만들기"를 선택합니다.
5. 경로 테이블 이름을 지정합니다. 여기에서는 "nested-nested-VMs"라고 지정됩니다.
6. Hyper-V 호스트가 상주하는 동일한 구독을 선택했는지 확인합니다.
7. 새 리소스 그룹을 만들거나 기존 리소스 그룹을 선택하고 경로 테이블을 만드는 지역이 Hyper-V 호스트가 상주하는 지역과 동일한지 확인합니다.
8. "만들기"를 선택합니다.

## <a name="configuring-the-route-table"></a>경로 테이블 구성

1. 방금 만든 경로 테이블로 이동합니다. 포털의 맨 위 가운데에 있는 검색 창에서 경로 테이블의 이름을 검색하면 됩니다.
2. 경로 테이블을 선택한 후 블레이드 내에서 "경로"로 이동합니다.
3. "추가"를 선택합니다.
4. 경로에 이름을 지정합니다. 여기에서는 "Nested-VMs"가 사용됩니다.
5. 주소 접두사의 경우 "부동" 서브넷에 대한 IP 범위를 입력합니다. 이 경우 10.0.2.0/24입니다.
6. "다음 홉 형식"에 "가상 어플라이언스"를 선택한 다음, Hyper-V 호스트 두 번째 NIC의 IP 주소인 10.0.1.4를 입력한 후 "확인"을 선택합니다.
7. 이제 블레이드 내에서 "서브넷"을 선택합니다. "경로" 바로 아래에 있습니다.
8. "연결"을 선택한 후 "Nested-Fun" VNet을 선택한 다음, "Azure-VMs" 서브넷을 선택한 후 "확인"을 선택합니다.
9. Hyper-V 호스트가 있는 서브넷 및 중첩된 VM에 액세스해야 하는 다른 서브넷에 대해서도 동일한 프로세스를 수행합니다. 연결된 경우 

# <a name="end-state-configuration-reference"></a>종료 상태 구성 참조
이 가이드의 환경에는 아래 구성이 있습니다. 이 섹션은 참조용으로 사용되어야 합니다.

1. Azure Virtual Network 정보
    * VNet 상위 수준 구성
        * 이름: Nested-Fun
        * 주소 공간: 10.0.0.0/22
        * 참고: 서브넷 4개로 구성됩니다. 또한 이 범위는 고정불변이 아닙니다. 원하는 방식으로 환경에 주소를 지정할 수 있습니다. 

    * 첫 번째 서브넷 상위 수준 구성
        * 이름: NAT
        * 주소 공간: 10.0.0.0/24
        * 참고: Hyper-V 호스트 기본 NIC가 상주하는 위치입니다. 중첩된 VM의 아웃바운드 NAT를 처리하는 데 사용됩니다. 중첩된 VM이 인터넷으로 연결하는 게이트웨이입니다.

    * 두 번째 서브넷 상위 수준 구성
        * 이름: Hyper-V-LAN
        * 주소 공간: 10.0.1.0/24
        * 참고:  Hyper-V 호스트에 두 번째 NIC가 있으며, 중첩된 VM과 Hyper-V 호스트 외부의 인터넷으로 사용할 수 없는 리소스 간에 라우팅을 처리하는 데 사용됩니다.

    * 세 번째 서브넷 상위 수준 구성
        * 이름: Ghosted
        * 주소 공간: 10.0.2.0/24
        * 참고:  "부동" 서브넷입니다. 이 주소 공간은 중첩된 VM에 사용되며 온-프레미스로 돌아가는 경로 광고를 처리하기 위해 존재합니다. 이 서브넷에는 VM이 실제로 배포되지 않습니다.

    * 네 번째 서브넷 상위 수준 구성
        * 이름: Azure-VMs
        * 주소 공간: 10.0.3.0/24
        * 참고: Azure VM을 포함하는 서브넷입니다.

1. Hyper-V 호스트의 NIC 구성은 다음과 같습니다.
    * 기본 NIC 
        * IP 주소: 10.0.0.4
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이 10.0.0.1
        * DNS: DHCP에 대해 구성됨
        * IP 전달 사용: 아니요

    * 보조 NIC
        * IP 주소: 10.0.1.4
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이 비어 있음
        * DNS: DHCP에 대해 구성됨
        * IP 전달 사용: 예

    * Hyper-V에서 내부 가상 스위치용으로 만든 NIC
        * IP 주소: 10.0.2.1
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이 비어 있음

3. 경로 테이블에는 단일 규칙이 포함됩니다.
    * 규칙 1
        * 이름: Nested-VMs
        * 대상: 10.0.2.0/24
        * 다음 홉: 가상 어플라이언스 - 10.0.1.4

## <a name="conclusion"></a>결론

이제 Hyper-V 호스트에 가상 머신(32비트 VM도 포함)을 배포하고 온-프레미스 및 Azure 내에서 액세스하도록 만들 수 있습니다.
