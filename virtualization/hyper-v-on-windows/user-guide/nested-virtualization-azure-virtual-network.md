---
title: Azure 가상 네트워크의 리소스와 직접 통신 하도록 중첩 된 Vm 구성
description: 중첩된 가상화
keywords: windows 10, hyper-v, Azure
author: mrajess
ms.date: 12/10/2018
ms.topic: article
ms.prod: windows-10-hyperv
ms.service: windows-10-hyperv
ms.assetid: 1ecb85a6-d938-4c30-a29b-d18bd007ba08
ms.openlocfilehash: efd180c458457da1cea6b379e21ba3a37083d15a
ms.sourcegitcommit: c4a3f88d1663dd19336bfd4ede0368cb18550ac7
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 07/31/2019
ms.locfileid: "9883266"
---
# <a name="configure-nested-vms-to-communicate-with-resources-in-an-azure-virtual-network"></a>Azure 가상 네트워크의 리소스와 통신 하도록 중첩 된 Vm 구성

Azure 내에서 중첩 된 가상 컴퓨터를 배포 하 고 구성 하는 데 사용 되는 원래 지침은 NAT 스위치를 통해 이러한 Vm에 액세스 해야 합니다. 다음과 같은 몇 가지 제한 사항이 제공 됩니다.

1. 중첩 된 Vm에서 온-프레미스 또는 Azure 가상 네트워크 내의 리소스에 액세스할 수 없습니다.
2. 온-프레미스 리소스 또는 Azure 내의 리소스는 NAT를 통해서만 중첩 된 Vm에 액세스할 수 있으며,이는 여러 게스트가 동일한 포트를 공유할 수 없음을 의미 합니다.

이 문서는 RRAS, 사용자 정의 경로, 게스트 인터넷 액세스를 허용 하는 아웃 바운드 NAT 전용 서브넷, "부동" 주소 공간을 사용 하 여 다른 모든 가상 컴퓨터와 같이 중첩 Vm이 작동 하 고 통신 하도록 하는 배포 과정을 안내 합니다. Azure 내에서 VNet에 직접 배포 됩니다.

이 가이드를 시작 하기 전에 다음을 수행 하세요.

1. 여기에서 [제공](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization) 하는 지침을 중첩 가상화에 읽으십시오.
2. 구현 하기 전에이 문서 전체를 읽어 보세요.

## <a name="high-level-overview-of-what-were-doing-and-why"></a>높은 수준의 개요 현재 수행 중인 작업 및 이유
* 두 개의 Nic가 있는 중첩 가능 VM을 만듭니다. 
* 하나의 NIC는 NAT를 통해 인터넷에 액세스할 수 있는 중첩 Vm을 제공 하는 데 사용 되며, 다른 NIC는 내부 스위치에서 하이퍼바이저 외부의 리소스로 트래픽을 라우팅하는 데 사용 됩니다. 각 NIC는 다른 라우팅 도메인에 있어야 하며 다른 서브넷을 의미 합니다.
* 즉, 최소한 3 개의 서브넷이 있는 가상 네트워크가 필요 합니다. NAT 용 1 개, LAN 라우팅 용 하나, 사용 되지 않는 항목, 그리고 중첩 된 Vm에는 "예약 됨"이 있습니다. 이 문서의 서브넷에 사용 하는 이름에는 "NAT", "Hyper-v-LAN" 및 "고스트"가 있습니다.
* 이러한 서브넷의 크기는 임의로 결정 되지만, 몇 가지 고려 사항이 있습니다. "고스트" 서브넷의 크기는 중첩 된 Vm에 대해 보유 한 Ip 수를 결정 합니다. 또한 "NAT" 및 "Hyper-v-LAN" 서브넷의 크기는 하이퍼바이저에 대해 사용 하는 Ip 수를 결정 합니다. 따라서 하나 또는 두 개의 하이퍼바이저만 있으면 기술적으로 매우 작은 서브넷을 만들 수 있습니다.
* 배경: 중첩 된 Vm은 내부 또는 외부 스위치를 구성 하는 경우에도 호스트가 연결 된 VNet에서 DHCP를 수신 하지 않습니다. 
  * 이는 Hyper-v 호스트가 DHCP를 제공 해야 함을 의미 합니다.
* Hyper-v 호스트는 VNet에서 현재 할당 된 임대를 인식 하지 않으므로 호스트가 이미 IP를 할당 하는 상황을 방지 하기 위해 Hyper-v 호스트 에서만 사용할 수 있도록 i p 블록을 할당 해야 합니다. 이렇게 하면 중복 IP 시나리오를 피할 수 있습니다.
  * 선택 하는 Ip 블록은 Hyper-v가 있는 동일한 VNet 내의 서브넷에 해당 합니다.
  * 이를 기존 서브넷과 일치 시킬 이유는 Express 경로를 통해 BGP 광고를 다시 처리 하는 것입니다. Hyper-v 호스트에서 사용할 IP 범위를 방금 구성한 경우에는 클라이언트가 프레미스에서 중첩 된 Vm과 통신할 수 있도록 하는 일련의 정적 경로를 만들어야 합니다. 이는 중첩 된 Vm에 대 한 IP 범위를 구성한 다음 해당 범위에 대 한 Hyper-v 호스트로 클라이언트를 안내 하는 데 필요한 모든 경로를 만들 때 발생 하는 것은 하드 요구 사항이 아닙니다.
* Hyper-v 내에서 내부 스위치를 만든 다음 DHCP에 대해 따로 설정한 범위 내에서 새로 만들어진 인터페이스에 IP 주소를 할당 합니다. 이 IP 주소는 중첩 된 Vm에 대 한 기본 게이트웨이가 되며, VNet에 연결 된 호스트의 내부 스위치와 NIC 간의 라우팅에 사용 됩니다.
* 호스트에 라우팅 및 원격 액세스 역할을 설치 하 게 되며,이는 호스트가 라우터로 전환 됩니다.  이는 호스트 및 중첩 된 Vm 외부의 리소스 간 통신을 허용 하는 데 필요 합니다.
* 이 중첩 된 Vm에 액세스 하는 방법에 대해서는 다른 리소스에 대해 설명 합니다. 이는 중첩 된 Vm이 있는 IP 범위에 대 한 고정 경로를 포함 하는 사용자 정의 경로 테이블을 만드는 것입니다. 이 고정 경로는 Hyper-v의 IP 주소를 가리킵니다.
* 그런 다음 온-프레미스에서 온 클라이언트가 중첩 된 Vm에 연결 하는 방법을 알 수 있도록 게이트웨이 서브넷에이 UDR을 배치 합니다.
* 또한이 UDR을 Azure 내의 다른 서브넷에 배치 하 여 중첩 된 Vm에 연결 해야 합니다.
* 여러 Hyper-v 호스트의 경우 추가 "부동" 서브넷을 만들고 UDR에 대 한 추가 고정 경로를 추가 합니다.
* Hyper-v 호스트의 역할을 해제 하면 "부동" 서브넷을 삭제/다시 사용할 수 있으며,이 고정 경로를 레 서 비 r에서 제거 하거나,이 호스트가 마지막 Hyper-v 호스트인 경우 레 서 비를 완전히 제거 해야 합니다.

## <a name="creating-the-host"></a>호스트 만들기

여기에는 VM 이름, 리소스 그룹 등과 같이 개인 취향에 맞는 구성 값이 나와 있습니다.

1. Portal.azure.com로 이동
2. 왼쪽 위에 있는 "리소스 만들기" 클릭
3. 인기 있는 열에서 "Window Server 2016 VM"을 선택 합니다.
4. "기본" 탭에서 중첩 가상화를 지 원하는 VM 크기를 선택 해야 합니다.
5. "네트워킹" 탭으로 이동
6. 다음 구성을 사용 하 여 새 가상 네트워크 만들기
    * VNet 주소 공간: 10.0.0.0/22
    * 서브넷 1
        * Name: NAT
        * 주소 공간: 10.0.0.0/24
    * 서브넷 2
        * 이름: Hyper-v-LAN
        * 주소 공간: 10.0.1.0/24
    * 서브넷 3
        * 이름: 고스트
        * 주소 공간: 10.0.2.0/24
    * 서브넷 4
        * 이름: Azure-Vm
        * 주소 공간: 10.0.3.0/24
7. VM에 대 한 NAT 서브넷을 선택 했는지 확인 합니다.
8. "검토 + 만들기"로 이동한 다음 "만들기"를 선택 합니다.

## <a name="create-the-second-network-interface"></a>두 번째 네트워크 인터페이스 만들기
1. VM이 프로 비전을 완료 한 후 Azure 포털 내에서 검색
2. VM 중지
3. 중지 후 설정에서 "네트워킹"으로 이동
4. "네트워크 인터페이스 연결"
5. "네트워크 인터페이스 만들기"
6. 이름 (이름에 관계 없이 이름을 지정 하 고 유의 해야 함)
7. 서브넷에 대해 "Hyper-v-LAN"을 선택 합니다.
8. 호스트가 속한 리소스 그룹을 선택 했는지 확인 합니다.
9. 만드는
10. 이전 화면으로 돌아가, 새로 생성 된 네트워크 인터페이스를 선택 하 고 "확인"을 선택 했는지 확인 합니다.
11. 이전 작업이 완료 되 면 "개요" 창으로 돌아가서 VM을 다시 시작 합니다.
12. 방금 만든 두 번째 NIC로 이동 하 여 이전에 선택한 리소스 그룹에서 찾을 수 있습니다.
13. "IP 구성"으로 이동 하 여 "IP 전달"을 "사용"으로 전환 하 고 변경 내용을 저장 합니다.

## <a name="setting-up-hyper-v"></a>Hyper-v 설정
1. 호스트로 원격
2. 관리자 권한 PowerShell 프롬프트 열기
3. 다음 명령을 실행 합니다. `Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart`
4. 호스트를 다시 시작 합니다.
5. 나머지 설치를 계속 하려면 호스트에 다시 연결

## <a name="creating-our-virtual-switch"></a>가상 스위치 만들기

1. 관리 모드에서 PowerShell을 엽니다.
2. 내부 스위치를 만듭니다. `New-VMSwitch -Name "NestedSwitch" -SwitchType Internal`
3. 새로 만들어진 인터페이스에 IP를 할당 합니다. `New-NetIPAddress –IPAddress 10.0.2.1 -PrefixLength 24 -InterfaceAlias "vEthernet (NestedSwitch)"`

## <a name="install-and-configure-dhcp"></a>DHCP 설치 및 구성

*대부분의 사용자는 중첩 가상화 작업을 처음 시도 하는 경우이 구성 요소를 놓치지 않습니다. 온-프레미스와 달리, 게스트 Vm이 호스트가 있는 네트워크에서 DHCP를 수신 하는 경우에는 Azure에서 중첩 된 Vm이 실행 되는 호스트를 통해 DHCP를 제공 해야 합니다. 즉, 확장 가능 하지 않은 모든 중첩 VM에 IP 주소를 정적으로 할당 해야 합니다.*

1. DHCP 역할 설치: `Install-WindowsFeature DHCP -IncludeManagementTools`
2. DHCP 범위 만들기: `Add-DhcpServerV4Scope -Name "Nested VMs" -StartRange 10.0.2.2 -EndRange 10.0.2.254 -SubnetMask 255.255.255.0`
3. 범위에 대 한 DNS 및 기본 게이트웨이 옵션을 구성 합니다. `Set-DhcpServerV4OptionValue -DnsServer 168.63.129.16 -Router 10.0.2.1`
    * 이름 확인이 작동 하도록 하려면 올바른 DNS 서버를 입력 해야 합니다. 여기서는 [Azure의 재귀 DNS](https://docs.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances)를 사용 합니다.

## <a name="installing-remote-access"></a>원격 액세스 설치

1. 서버 관리자를 열고 "역할 및 기능 추가"를 선택 합니다.
2. "서버 역할"에 도달할 때까지 "다음"을 선택 합니다.
3. "원격 액세스"를 선택 하 고 "역할 서비스"가 나타날 때까지 "다음"을 클릭 합니다.
4. "라우팅"을 확인 하 고 "기능 추가"를 선택한 후 "다음"을 선택한 후 "설치"를 선택 합니다. 마법사를 완료 하 고 설치가 완료 될 때까지 기다립니다.

## <a name="configuring-remote-access"></a>원격 액세스 구성

1. 서버 관리자를 열고 "도구"를 선택한 다음 "라우팅 및 원격 액세스"를 선택 합니다.
2. 라우팅 및 원격 액세스 관리 패널의 왼쪽에 서버 이름 옆에 아이콘이 표시 되 고, 마우스 오른쪽 단추를 클릭 하 고 "라우팅 및 원격 액세스 사용 및 구성"을 선택 합니다.
3. 마법사에서 "다음"을 선택 하 고 "사용자 지정 구성"에 대 한 방사형 단추를 선택한 후 "다음"을 선택 합니다.
4. "NAT" 및 "LAN 라우팅"을 확인 하 고 "다음"을 선택한 후 "완료"를 선택 합니다. 서비스를 시작 하 라는 메시지가 표시 되 면이를 실행 합니다.
5. 이제 "IPv4" 노드로 이동 하 여 "NAT" 노드를 사용할 수 있게 확장 합니다.
6. "NAT"를 마우스 오른쪽 단추로 클릭 하 고 "새 인터페이스 ..."를 선택 합니다. "Ethernet"을 선택 하면 "10.0.0.4" IP를 사용 하는 첫 번째 NIC 이어야 합니다.
7. 이제 LAN 트래픽을 두 번째 NIC에 강제 하는 몇 가지 정적 경로를 생성 해야 합니다. "IPv4" 아래의 "고정 경로" 노드로 이동해 서이 작업을 수행 합니다.
8. 그런 후 다음 경로를 만듭니다.
    * 경로 1
        * 인터페이스: Ethernet
        * 대상: 10.0.0.0
        * 네트워크 마스크: 255.255.255.0
        * 게이트웨이: 10.0.0.1
        * 메트릭: 256
        * 참고: 기본 NIC가 자체 인터페이스를 통해 전송 되는 트래픽에 응답할 수 있도록이 위치를 여기에 배치 합니다. 여기에이를 포함 하지 않으면 다음 경로에서 nic 1에 대 한 트래픽이 NIC 2로 이동 됩니다. 이는 비대칭 경로를 만듭니다. 10.0.0.1은 Azure가 NAT 서브넷에 할당 하는 IP 주소입니다. Azure는 범위에서 사용 가능한 첫 번째 IP를 기본 게이트웨이로 사용 합니다. 따라서 NAT 서브넷에 192.168.0.0/24를 사용한 경우 게이트웨이는 192.168.0.1이 됩니다. 더 구체적인 경로를 라우팅할 때이 경로는 아래 경로를 대체 합니다.

    * 경로 2
        * 인터페이스: Ethernet 2
        * 대상: 10.0.0.0
        * 네트워크 마스크: 255.255.252.0
        * 게이트웨이: 10.0.1.1
        * 메트릭: 256
        * 참고: Azure VNet에 대 한 모든 트래픽에 대 한 모든 경로를 파악 하는 것입니다. 두 번째 NIC에서 강제로 트래픽을 강제 실행 합니다. 중첩 된 Vm에서 액세스할 다른 범위에 대 한 경로를 추가 해야 합니다. 따라서 프레미스 네트워크가 172.16.0.0/22 인 경우에는 하이퍼바이저의 두 번째 NIC에서 해당 트래픽을 전송 하는 다른 경로를 사용 하려고 합니다.

## <a name="creating-a-route-table-within-azure"></a>Azure 내에서 경로 테이블 만들기

Azure 내에서 경로를 만들고 관리 하는 방법에 대 한 자세한 내용을 보려면 [이 문서](https://docs.microsoft.com/azure/virtual-network/tutorial-create-route-table-portal) 를 참조 하세요.

1. 으로 https://portal.azure.com이동 합니다.
2. 왼쪽 위 모서리에서 "리소스 만들기"를 선택 합니다.
3. 검색 필드에 "경로 테이블"을 입력 하 고 enter 키를 누릅니다.
4. 상위 결과는 경로 테이블을 선택 하 고이를 선택한 다음, "만들기"를 선택 합니다.
5. 경로 테이블의 이름을 "이름에 따라-Vm-a I a e" 라고 명명 합니다.
6. Hyper-v 호스트가 상주 하는 것과 동일한 구독을 선택 했는지 확인 합니다.
7. 새 리소스 그룹을 만들거나 기존 항목을 선택 하 고 경로 테이블을 만드는 영역이 Hyper-v 호스트가 있는 지역과 동일한 지 확인 합니다.
8. "만들기"를 선택 합니다.

## <a name="configuring-the-route-table"></a>경로 테이블 구성

1. 방금 만든 경로 테이블로 이동 합니다. 포털의 위쪽 가운데에 있는 검색 표시줄에서 경로 테이블의 이름을 검색 하 여이 작업을 수행할 수 있습니다.
2. 경로 테이블을 선택한 후에는 블레이드 내에서 "경로"로 이동 합니다.
3. "추가"를 선택 합니다.
4. 경로에 이름을 지정 하 고 "내장 Vm"을 사용해 보세요.
5. 주소 접두사에는 "부동" 서브넷에 대 한 IP 범위를 입력 합니다. 이 경우 10.0.2.0/24가 될 수 있습니다.
6. "다음 홉 유형"의 경우 "가상 기기"를 선택 하 고 10.0.1.4 된 Hyper-v 호스트의 IP 주소를 입력 한 다음 "확인"을 선택 합니다.
7. 이제 블레이드 내에서 "서브넷"을 선택 하면 "경로" 바로 아래에 있습니다.
8. "연결"을 선택 하 고 "중첩 된 재미" VNet을 선택한 다음 "Azure-Vm" 서브넷을 선택한 다음 "확인"을 선택 합니다.
9. Hyper-v 호스트가 있는 서브넷과 중첩 된 Vm에 액세스 해야 하는 다른 서브넷에 대해서도 동일한 프로세스를 수행 합니다. 연결 되어 있는 경우 

# <a name="end-state-configuration-reference"></a>종료 상태 구성 참조
이 가이드의 환경에는 다음과 같은 구성이 있습니다. 이 섹션은 참조로 사용할 inteded.

1. Azure 가상 네트워크 정보.
    * VNet 상위 수준 구성
        * 이름: 재미 있는
        * 주소 공간: 10.0.0.0/22
        * 참고:이 작업은 4 개의 서브넷으로 구성 됩니다. 또한 이러한 범위는 석재에 설정 되지 않습니다. 원하는 환경에 대 한 주소를 자유롭게 지정할 수 있습니다. 

    * 첫 번째 서브넷 상위 수준 구성입니다.
        * Name: NAT
        * 주소 공간: 10.0.0.0/24
        * 참고: 여기에는 기본 NIC가 있는 Hyper-v 호스트가 있습니다. 이는 중첩 된 Vm에 대 한 아웃 바운드 NAT를 처리 하는 데 사용 됩니다. 이는 중첩 된 Vm의 인터넷에 대 한 게이트웨이입니다.

    * 두 번째 서브넷 상위 수준 구성입니다.
        * 이름: Hyper-v-LAN
        * 주소 공간: 10.0.1.0/24
        * 참고: Hyper-v 호스트에는 중첩 된 Vm 및 Hyper-v 호스트 외부의 비 인터넷 리소스 간 라우팅을 처리 하는 데 사용 되는 두 번째 NIC가 있습니다.

    * 세 번째 서브넷 상위 수준 구성입니다.
        * 이름: 고스트
        * 주소 공간: 10.0.2.0/24
        * 참고:이는 "부동" 서브넷입니다. 주소 공간은 중첩 된 Vm에서 사용 되며, 온-프레미스에 대 한 경로 알림을 다시 처리 하기 위해 존재 합니다. 이 서브넷에 실제 Vm이 배포 되지 않습니다.

    * 네 번째 서브넷 상위 수준 구성입니다.
        * 이름: Azure-Vm
        * 주소 공간: 10.0.3.0/24
        * 참고: Azure Vm을 포함 하는 서브넷입니다.

1. Hyper-v 호스트에는 아래 NIC 구성이 있습니다.
    * 기본 NIC 
        * IP 주소: 10.0.0.4
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이: 10.0.0.1
        * DNS: DHCP에 대해 구성 됨
        * IP 착신 전환 사용: 아니요

    * 보조 NIC
        * IP 주소: 10.0.1.4
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이: 비어 있음
        * DNS: DHCP에 대해 구성 됨
        * IP 전달 사용: 예

    * Hyper-v가 내부 가상 스위치에 대 한 NIC를 만들었습니다.
        * IP 주소: 10.0.2.1
        * 서브넷 마스크: 255.255.255.0
        * 기본 게이트웨이: 비어 있음

3. 저희 경로 테이블에는 단일 규칙이 있습니다.
    * 규칙 1
        * Name: a-Vm
        * 대상: 10.0.2.0/24
        * 다음 홉: 가상 기기-10.0.1.4

## <a name="conclusion"></a>결론

이제 Hyper-v 호스트에 가상 머신 (32 비트 VM 포함)를 배포 하 고 온-프레미스 및 Azure 내에서 액세스할 수 있도록 할 수 있습니다.
