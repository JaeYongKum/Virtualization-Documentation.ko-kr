---
title: 타이머
description: 하이퍼바이저 타이머
keywords: hyper-v
author: alexgrest
ms.author: alegre
ms.date: 10/15/2020
ms.topic: reference
ms.prod: windows-10-hyperv
ms.openlocfilehash: acd5139517194db4f790f27e8b5cf12b3eac1749
ms.sourcegitcommit: d43632e3dc22e2b7a256b5c15fbb665c047de286
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 10/16/2020
ms.locfileid: "92121224"
---
# <a name="timers"></a>타이머

하이퍼바이저는 간단한 타이밍 서비스를 제공 합니다. 이러한 작업은 상수 등급 참조 시간 원본 (일반적으로 x64 시스템의 ACPI 타이머)을 기반으로 합니다.

제공 되는 타이머 서비스는 다음과 같습니다.

- 파티션당 참조 시간 카운터입니다.
- 가상 프로세서 당 4 개의 가상 타이머 각 가상 타이머는 메시지를 배달 하거나 만료 될 때 인터럽트를 어설션하는 단일 샷 또는 정기 타이머입니다.
- 가상 프로세서 당 하나의 가상 APIC 타이머.
- 파티션 참조 시간 계몽 (고정 타임 스탬프 카운터 (iTSC)에 대 한 호스트 플랫폼 지원).

## <a name="reference-counter"></a>참조 카운터

하이퍼바이저는 파티션당 참조 시간 카운터를 유지 관리 합니다. 이 클래스에는 파티션의 모든 가상 프로세서에서 볼 수 있는 것 처럼, 그에 대 한 연속 액세스에서 엄격한 시간 값을 반환 하는 특성이 있습니다. 또한 참조 카운터는 속도 상수 이며 프로세서 또는 버스 속도 전환 또는 심층 프로세서 전원 절약 상태의 영향을 받지 않습니다. 파티션을 만들 때 파티션의 reference time 카운터는 0으로 초기화 됩니다. 모든 파티션에 대 한 참조 카운터는 동일한 속도로 계산 되지만, 파티션에는 생성 시간이 달라 지므로 일반적으로 절대 값은 다릅니다.

하나 이상의 가상 프로세서가 명시적으로 일시 중단 되지 않는 한 참조 카운터는 계속 해 서 계산 됩니다.

### <a name="partition-reference-counter-msr"></a>파티션 참조 카운터 MSR

파티션 전체 MSR을 통해 파티션의 참조 카운터에 액세스할 수 있습니다.

| MSR 주소      | 이름 등록              | Description                                                                 |
|------------------|----------------------------|-----------------------------------------------------------------------------|
| 0x40000020       | HV_X64_MSR_TIME_REF_COUNT  | 시간 참조 수 (파티션 전체)                                       |

파티션이 만들어지면 TIME_REF_COUNT MSR 값이 0 x 0000000000000000로 설정 됩니다. 이 값은 가상 프로세서에서 수정할 수 없습니다. 이에 쓰려고 하면 #GP 오류가 발생 합니다.

### <a name="partition-reference-time-enlightenment"></a>파티션 참조 시간 계몽

파티션 참조 시간 계몽은 하이퍼바이저에 대 한 인터셉트를 요구 하지 않는 파티션에 대 한 참조 시간 원본을 제공 합니다. 이 계몽은 기본 플랫폼이 TSC (고정 프로세서 타임 스탬프 카운터) 또는 iTSC를 지 원하는 경우에만 사용할 수 있습니다. 이러한 플랫폼에서 processor TSC frequency는 ACPI 프로세서 성능 상태, 프로세서 유휴 상태 (ACPI C-상태) 등의 전원 관리 상태를 사용 하기 때문에 프로세서의 클록 주파수 변경에 관계 없이 유지 됩니다.

파티션 참조 시간 계몽은 가상 TSC 값, 오프셋 및 승수를 사용 하 여 파티션 생성 이후 정규화 된 참조 시간을 (100Ns 단위로 계산 하도록 게스트 파티션을 설정 합니다. 또한이 메커니즘을 사용 하면 게스트 파티션이 다른 TSC 속도로 플랫폼으로 마이그레이션되는 경우 참조 시간을 원자 단위로 계산 하 고, 상수 rate TSC 기능 없이 플랫폼으로의 마이그레이션을 지 원하는 대체 메커니즘을 제공할 수 있습니다.

이 기능을 사용 하 여 계산 된 참조 시간이 후속 복원까지 게스트 파티션이 저장 되는 시간 동안 중지 된 것 처럼 보일 수 있으므로이 기능은 벽 시계 시간의 원본으로 사용 하기 위한 것이 아닙니다.

#### <a name="partition-reference-time-stamp-counter-page"></a>파티션 참조 타임 스탬프 카운터 페이지

하이퍼바이저는 파티션의 GPA 공간에 중첩 된 파티션 전체 가상 참조 TSC 페이지를 제공 합니다. 파티션의 참조 타임 스탬프 카운터 페이지는 참조 TSC MSR을 통해 액세스할 수 있습니다.

참조 TSC 페이지는 다음 구조를 사용 하 여 정의 됩니다.

 ```c
typedef struct
{
    volatile UINT32 TscSequence;
    UINT32 Reserved1;
    volatile UINT64 TscScale;
    volatile INT64 TscOffset;
    UINT64 Reserved2[509];
} HV_REFERENCE_TSC_PAGE;
 ```

#### <a name="reference-time-stamp-counter-tsc-page-msr"></a>참조 타임 스탬프 카운터 (TSC) 페이지 MSR

참조 TSC 페이지에 액세스 하려는 게스트는 다음 MSR (model 특정 등록)을 사용 해야 합니다. AccessPartitionReferenceTsc 권한을 소유 하는 파티션은 MSR에 액세스할 수 있습니다.

| MSR 주소      | 이름 등록              | Description                                                                 |
|------------------|----------------------------|-----------------------------------------------------------------------------|
| 0x40000021       | HV_X64_MSR_REFERENCE_TSC   | 참조 TSC 페이지                                                          |

| 비트          | Description                         | 특성                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:12         | GPA 페이지 번호                     | 읽기/쓰기                                                |
| 11:1          | RsvdP (값을 유지 해야 함)   | 읽기/쓰기                                                |
| 0             | 사용                              | 읽기/쓰기                                                |

게스트 파티션 생성 시 참조 TSC MSR의 값은 0 x 0000000000000000입니다. 따라서 참조 TSC 페이지는 기본적으로 사용 하지 않도록 설정 되어 있습니다. 게스트는 비트 0을 설정 하 여 reference TSC 페이지를 사용 하도록 설정 해야 합니다. 지정 된 기본 주소가 파티션에 있는 GPA 공간의 끝을 초과 하면 참조 TSC 페이지에 게스트가 액세스할 수 없게 됩니다. 등록을 수정 하는 경우 게스트는 이후 버전과의 호환성을 위해 예약 된 비트 (1-11)의 값을 유지 해야 합니다.

#### <a name="partition-reference-tsc-mechanism"></a>파티션 참조 TSC 메커니즘

파티션 참조 시간은 다음 수식으로 계산 됩니다.

ReferenceTime = ((VirtualTsc * TscScale)  >> 64) + TscOffset

곱하기는 64 비트 곱하기로, 128 비트는 비트를 반환 하며, 64 64이는 비트를 반환 합니다 .이는 비트를 반환 합니다 .이는 비트를 반환 합니다.

TscScale 값은 특정 플랫폼에서 다른 플랫폼으로의 TSC 빈도 변경을 완화 하기 위해 마이그레이션 이벤트에서 가상 TSC 값을 조정 하는 데 사용 됩니다.

TscSequence 값은 저장/복원 또는 실시간 마이그레이션 중에 크기 조정 및/또는 오프셋 필드가 변경 된 경우 지원 참조 시간에 대 한 액세스를 동기화 하는 데 사용 됩니다. 이 필드는 배율 및/또는 오프셋 필드가 수정 될 때마다 증가 하는 시퀀스 번호의 역할을 합니다. 특수 값 0x0은이 기능이 더 이상 신뢰할 수 있는 참조 시간 소스가 아니라 VM이 다른 원본으로 대체 되어야 함을 나타내는 데 사용 됩니다.

이 계몽을 사용 하 여 파티션 참조 시간을 계산 하는 데 권장 되는 코드는 다음과 같습니다.

```c
do
{
    StartSequence = ReferenceTscPage->TscSequence;
    if (StartSequence == 0)
    {
        // 0 means that the Reference TSC enlightenment is not available at
        // the moment, and the Reference Time can only be obtained from
        // reading the Reference Counter MSR.
        ReferenceTime = rdmsr(HV_X64_MSR_TIME_REF_COUNT);
        return ReferenceTime;
    }

    Tsc = rdtsc();

    // Assigning Scale and Offset should neither happen before
    // setting StartSequence, nor after setting EndSequence.
    Scale = ReferenceTscPage->TscScale;
    Offset = ReferenceTscPage->TscOffset;

    EndSequence = ReferenceTscPage->TscSequence;
} while (EndSequence != StartSequence);

// The result of the multiplication is treated as a 128-bit value.
ReferenceTime = ((Tsc * Scale) >> 64) + Offset;
return ReferenceTime;
```

## <a name="synthetic-timers"></a>가상 타이머

가상 타이머는 나중에 지정 된 시간 후에 인터럽트를 생성 하는 메커니즘을 제공 합니다. 단일 샷 및 주기적인 타이머가 모두 지원 됩니다. 가상 타이머가 만료 되 면 지정 된 Syic SINTx (가상 인터럽트 원본)로 메시지를 보내거나 구성 된 방법에 따라 인터럽트를 어설션 합니다.

하이퍼바이저는 만료 시간 이전에 타이머 만료 신호를 배달 하지 않도록 보장 합니다. 만료 시간 이후 언제 든 지 신호가 도착할 수 있습니다.

### <a name="periodic-timers"></a>주기적 타이머

하이퍼바이저는 정기적으로 정기적으로 타이머 신호를 시도 합니다. 그러나 만료 신호를 보내는 데 사용 되는 가상 프로세서를 사용할 수 없는 경우에는 타이머 만료 중 일부가 지연 될 수 있습니다. 가상 프로세서는 일시 중단 되었거나 (예: 가로채기 처리 중) 하이퍼바이저의 스케줄러가 논리 프로세서에서 가상 프로세서를 예약 하지 않도록 결정 한 경우 (예: 다른 가상 프로세서가 논리 프로세서를 사용 하 고 있거나 가상 프로세서가 할당량을 초과 했기 때문에) 사용 하지 못할 수 있습니다.

충분 한 시간 동안 가상 프로세서를 사용할 수 없는 경우 전체 타이머 기간이 누락 될 수 있습니다. 이 경우 하이퍼바이저는 두 가지 방법 중 하나를 사용 합니다.

첫 번째 방법은 타이머를 변조 하는 것입니다 .이 경우 타이머가 "catch" 될 때까지 기간이 단축 됩니다. 많은 수의 타이머 신호가 누락 된 경우 하이퍼바이저는 period 변조를 사용 하 여 보정 하지 못할 수 있습니다. 이 경우 일부 타이머 만료 신호를 완전히 건너뛸 수 있습니다.

지연으로 표시 된 타이머의 경우 하이퍼바이저는 오랜 시간 동안 가상 프로세서를 사용할 수 없는 상황을 처리 하기 위해 두 번째 기법을 사용 합니다. 이 경우 타이머 신호는이 가상 프로세서를 사용할 수 있을 때까지 지연 됩니다. 다음 타이머가 만료 되기 직전까지 사용할 수 없게 되 면 완전히 건너뜁니다.

### <a name="ordering-of-timer-expirations"></a>타이머 만료 순서 지정

가상 및 가상화 된 타이머는 지정 된 만료 시간에 또는 그 근처에 인터럽트를 생성 합니다. 하드웨어 및 기타 예약 상호 작용으로 인해 인터럽트가 지연 될 수 있습니다. 모든 타이머 집합 간에 순서를 지정할 수 없습니다.

### <a name="direct-synthetic-timers"></a>직접 가상 타이머

"직접" 가상 타이머는 Syic 가상 인터럽트 원본으로 메시지를 전송 하는 대신 타이머 만료 시 인터럽트를 어설션 합니다. 가상 타이머 구성 MSRs의 "DirectMode" 필드를 설정 하 여 가상 타이머를 "직접" 모드로 설정 합니다. "ApicVector" 필드는 타이머 만료 시 어설션된 인터럽트 벡터를 제어 합니다.

### <a name="synthetic-timer-msrs"></a>가상 타이머 MSRs

가상 타이머는 각 가상 프로세서와 연결 된 MSRs (모델 관련 레지스터)를 사용 하 여 구성 됩니다. 4 개의 가상 타이머 각각에는 관련 된 MSRs 쌍이 있습니다.

| MSR 주소      | 이름 등록                   | Description                                                    |
|------------------|---------------------------------|----------------------------------------------------------------|
| 0x400000B0       | HV_X64_MSR_STIMER0_CONFIG       | 가상 타이머 0의 구성 등록입니다.                  |
| 0x400000B1       | HV_X64_MSR_STIMER0_COUNT        | 가상 타이머 0의 만료 시간 또는 기간입니다.               |
| 0x400000B2       | HV_X64_MSR_STIMER1_CONFIG       | 가상 타이머 1의 구성 등록입니다.                  |
| 0x400000B3       | HV_X64_MSR_STIMER1_COUNT        | 가상 타이머 1의 만료 시간 또는 기간입니다.               |
| 0x400000B4       | HV_X64_MSR_STIMER2_CONFIG       | 가상 타이머 2에 대 한 구성 등록                  |
| 0x400000B5       | HV_X64_MSR_STIMER2_COUNT        | 가상 타이머 2에 대 한 만료 시간 또는 기간입니다.               |
| 0x400000B6       | HV_X64_MSR_STIMER3_CONFIG       | 가상 타이머 3의 구성 등록입니다.                  |
| 0x400000B7       | HV_X64_MSR_STIMER4_COUNT        | 가상 타이머 3의 만료 시간 또는 기간입니다.               |

#### <a name="synthetic-timer-configuration-register"></a>가상 타이머 구성 등록

| 비트          | Description                         | 특성                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:20         | RsvdZ (값을 0으로 설정 해야 함) | 읽기/쓰기                                                |
| 19:16         | SINTx-가상 인터럽트 원본  | 읽기/쓰기                                                |
| 15:13         | RsvdZ (값을 0으로 설정 해야 함) | 읽기/쓰기                                                |
| 12            | 직접 모드-타이머 만료 시 어설션 및 중단 합니다. | 읽기/쓰기                          |
| 11:4          | ApicVector-직접 모드에서 어설션된 인터럽트 벡터를 제어 합니다. | 읽기/쓰기                 |
| 3             | AutoEnable-해당 하는 카운터를 작성 하면 타이머가 활성화 되도록 암시적으로 설정 합니다. | 읽기/쓰기 |
| 2             | 타이머가 lazy 인 경우 지연 설정          | 읽기/쓰기                                               |
| 1             | 정기적-타이머가 정기 인 경우 설정  | 읽기/쓰기                                               |
| 0             | Enabled-타이머를 사용 하는 경우 설정    | 읽기/쓰기                                               |

가상 프로세서를 만들고 다시 설정 하면 모든 HV_X64_MSR_STIMERx_CONFIG (가상 타이머 구성) 레지스터의 값이 0 x 0000000000000000로 설정 됩니다. 따라서 모든 가상 타이머는 기본적으로 사용 하지 않도록 설정 됩니다.

AutoEnable이 설정 된 경우 0이 아닌 값을 해당 카운트 레지스터에 쓰면에서 사용 하도록 설정 되 고 카운터가 활성화 됩니다. 그렇지 않으면 카운터를 활성화 하기 위해 해당 카운트 레지스터를 작성 한 후 사용을 설정 해야 합니다. 개수 등록에 대 한 자세한 내용은 다음 섹션을 참조 하세요.

단일 샷 타이머가 만료 되 면 자동으로 사용 안 함으로 표시 됩니다. 정기적 타이머는 명시적으로 사용 하지 않도록 설정 된 상태로 유지 됩니다.

한 번의 샷을 사용 하도록 설정 하 고 지정 된 수를 지난 경우 즉시 만료 됩니다.

설정 된 타이머 (직접 모드에 있지 않음)의 경우 SINTx 필드를 0으로 설정할 수 없습니다. 시도 하는 경우 타이머는 사용 안 함으로 표시 됩니다 (즉, 비트 0 지우기).

이미 사용 하도록 설정 된 타이머의 구성 레지스터를 작성 하면 정의 되지 않은 동작이 발생할 수 있습니다. 예를 들어, 특정 샷의 타이머를 정기적으로 변경 하면 의도 한 것이 생성 되지 않을 수 있습니다. 타이머는 다른 속성을 변경 하기 전에 항상 사용 하지 않도록 설정 해야 합니다.

#### <a name="synthetic-timer-count-register"></a>가상 타이머 개수 등록

| 비트          | Description                                                             | 특성              |
|---------------|-------------------------------------------------------------------------|-------------------------|
| 63:0          | Count-단일 샷 타이머에 대 한 만료 시간, 정기 타이머의 기간 | 읽기/쓰기            |

개수 레지스터에 프로그래밍 된 값은 100 나노초 단위로 측정 된 시간 값입니다. 카운트 레지스터에 값 0을 쓰면 카운터가 중지 되므로 구성 레지스터의 AutoEnable 설정과 관계 없이 타이머가 비활성화 됩니다.

개수 레지스터를 래핑할 수 있습니다. 줄 바꿈은 타이머 속성에 관계 없이 타이머의 동작에 영향을 주지 않습니다.

단일 샷 타이머의 경우이는 절대 타이머 만료 시간을 나타냅니다. 파티션에 대 한 참조 카운터가 지정 된 개수 값 보다 크거나 같으면 타이머가 만료 됩니다.

정기 타이머의 경우 개수는 타이머의 기간을 나타냅니다. 가상 타이머를 사용 하도록 설정 하면 첫 번째 기간이 시작 됩니다.

### <a name="synthetic-timer-expiration-message"></a>가상 타이머 만료 메시지

타이머 만료 메시지는 타이머 이벤트가 발생 하는 경우에 전송 됩니다. 메시지 페이로드의 정의는 [HV_TIMER_MESSAGE_PAYLOAD](datatypes/HV_TIMER_MESSAGE_PAYLOAD.md) 를 참조 하세요.

### <a name="synthetic-time-unhalted-timer-msrs"></a>가상 Time-Unhalted 타이머 MSRs

가상 Time-Unhalted 타이머 MSRs는 파티션에 AccessSyntheticTimerRegs 권한이 있고 하이퍼바이저 기능 Id의 EDX 비트 23이 설정 된 경우 사용할 수 있습니다. 게스트 소프트웨어는 지정 된 시간 (100ns 단위 동안 실행 된 후에 발생 하는 가상 시간-중지 된 타이머를 프로그래밍 하 여 정기적인 인터럽트를 생성할 수 있습니다. 인터럽트가 발생 하면 VP 지원 페이지의 SyntheticTimeUnhaltedTimerExpired 필드가 TRUE로 설정 됩니다. 게스트 소프트웨어는이 필드를 FALSE로 다시 설정할 수 있습니다. 아키텍처 성능 카운터와 달리 가상 타이머는 하이퍼바이저에 의해 다시 설정 되지 않으며 인터럽트 사이에서 지속적으로 실행 됩니다. 벡터 = = 2 NMI를 보내고 다른 벡터는 고정 된 인터럽트를 보냅니다.

게스트가 중단 된 시간을 누적 하는 일반 가상 타이머와 달리 (ie: idle), 가상 Time-Unhalted 타이머는 게스트가 중단 되지 않는 동안에만 시간을 누적 합니다.

| MSR 주소      | 이름 등록                          | Description                                             |
|------------------|----------------------------------------|---------------------------------------------------------|
| 0x40000114       | HV_X64_MSR_STIME_UNHALTED_TIMER_CONFIG | 가상 Time-Unhalted 타이머 구성 MSR         |
| 0x40000115       | HV_X64_MSR_STIME_UNHALTED_TIMER_COUNT  | 가상 Time-Unhalted 타이머 수 MSR                 |

#### <a name="synthetic-time-unhalted-timer-configuration-msr"></a>가상 Time-Unhalted 타이머 구성 MSR

| 비트          | Description                         | 특성                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:9          | RsvdZ (값을 0으로 설정 해야 함) | 읽기/쓰기                                                |
| 8             | 사용                             | 읽기/쓰기                                                |
| 7:0           | 벡터                              | 읽기/쓰기                                                |

#### <a name="synthetic-time-unhalted-timer-count-msr"></a>가상 Time-Unhalted 타이머 수 MSR

| 비트          | Description                                                             | 특성              |
|---------------|-------------------------------------------------------------------------|-------------------------|
| 63:0          | 100 ns 단위의 최대 인터럽트 주기                             | 읽기/쓰기            |