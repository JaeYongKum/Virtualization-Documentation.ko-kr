# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>CVE-2017-5715에서 게스트 가상 컴퓨터 보호(분기표적 주입)

이 페이지에서는 CVE-2017-5715(분기표적 주입)의 Hyper-V 호스트에 있는 가상 컴퓨터를 보호하는 데 대한 추가 세부 정보를 제공합니다.  일반 Windows Server 참고 자료는 [이 페이지](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)를 참조하세요.

가상 컴퓨터가 보호되고 있는지 확인하려면 다음 단계를 수행해야 합니다.

1. 호스트 운영 체제를 업데이트합니다.
2. 가상화 호스트가 CVE-2017-5715의 업데이트가 포함된 펌웨어로 업데이트되었는지 확인합니다.
3. Hyper-V가 게스트 가상 컴퓨터에 새 프로세서 기능을 제공하도록 구성되어 있는지 확인합니다.
4. 필요에 따라 게스트 운영 체제를 업데이트합니다. 
5. 게스트 가상 컴퓨터의 콜드 부팅을 수행합니다.

## <a name="update-the-host-operating-system"></a>호스트 운영 체제 업데이트

Windows 운영 체제 업데이트를 가상화 호스트에 적용합니다. 이 업데이트를 사용하는 방법에 대한 세부 정보는 [Microsoft 기술 자료 문서 4072699](https://support.microsoft.com/help/4072699)를 참조하세요.

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>가상화 호스트가 CVE-2017-5715의 업데이트가 포함된 펌웨어로 업데이트되었는지 확인

OEM의 펌웨어 업데이트에는 CVE-2017-5715([STIBP, IBRS IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf))으로부터 보호하는 데 사용할 수 있는 새로운 프로세서 기능이 포함되어 있을 수 있습니다.  가상화 호스트의 펌웨어를 업데이트하면 하이퍼바이저가 다음 단계를 수행한 후 게스트 가상 컴퓨터에서 이러한 추가 기능을 사용할 수 있게 합니다.

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>Hyper-V가 게스트 가상 컴퓨터에 새 프로세서 기능을 제공하도록 구성되어 있는지 확인

Hyper-v 게스트 가상 컴퓨터에 새 프로세서 기능을 제공 하도록 구성 되어 있는지 확인 합니다.  이 구성은 [VM 버전](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server)의 게스트 가상 컴퓨터를 기반으로 합니다. 

호스트의 모든 가상 컴퓨터가 VM 버전 8.0 이상인 경우 구성이 필요하지 않습니다.  이러한 가상 컴퓨터는 콜드 부팅 후에 새 프로세서 기능을 볼 수 있습니다.

가상 컴퓨터가 8.0보다 낮은 버전의 VM인 경우 호스트 운영 체제에 특정 레지스트리 값을 설정해야 합니다.  이 값은 Hyper-V가 낮은 VM 버전의 게스트 가상 컴퓨터에 새 프로세서 기능을 제공하도록 구성합니다.

해당 레지스트리 값은 `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`에 있는 `MinVmVersionForCpuBasedMitigations`입니다.  값은 업데이트된 펌웨어 기능에 액세스하는 데 필요한 최소 VM 버전으로 설정되어야 하며 형식은 "Major.Minor"입니다.  호스트의 모든 가상 컴퓨터(예: 버전 1.0 이상)에 펌웨어를 제공하려면 호스트에서 다음 명령을 실행하세요. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*참고: VM 버전 8.0은 Windows Server 2016 및 Windows 10 1주년 업데이트와 함께 소개되었습니다.  Windows Server 2012 R2 이하가 실행되는 호스트는 레지스트리 값을 설정해야 함*

*경고: 업데이트된 펌웨어가 있는 호스트와 업데이트된 펌웨어가 없는 호스트 간의 실시간 마이그레이션은 실패합니다.  자세한 내용은 이 문서의 아래에 있는 FAQ를 참조하세요.*

## <a name="optional-configure-pre-skylake-intel-systems-to-use-retpoline"></a>*옵션*: Retpoline를 사용 하 여 _사전 Skylake_ Intel 시스템 구성

*경고: Retpoline는 최신 호스트로 실시간 마이그레이션을 차단에 대 한 사전 Skylake Intel 호스트에서 Vm을 구성 (예: Skylake 32tb 이상).*

기본적으로 retpoline를 사용 하 여 사전 Skylake 시스템에서 실행 중인 가상 컴퓨터 수 없습니다.  설정 기반 retpoline 완화를 활용 하 여 이러한 시스템을 허용 하려면 `RetsPredictedFromRsbOnly` 에서 `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` 를 `1`합니다. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

이 구성은 되돌릴 수 (즉, 가상 컴퓨터에서 활용 retpoline)를 방지 설정 `RetsPredictedFromRsbOnly` 를 `0`.

## <a name="update-the-guest-operating-system"></a>게스트 운영 체제 업데이트

이러한 가상 컴퓨터에서 CVE-2017-5715에 대한 보호를 완료하려면 게스트 운영 체제가 업데이트되고 이러한 새로운 기능을 활용하도록 구성되어야 합니다.  Microsoft 운영 체제의 경우 업데이트할 때 [이 문서](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)의 지침을 따르세요.

*참고: 이 프로세스에서 언제든지 게스트 운영 체제를 업데이트할 수 있습니다.  호스트 펌웨어를 업데이트하기 전이나 게스트 가상 컴퓨터를 콜드 부팅한 후에 업데이트할 수 있습니다.*

## <a name="perform-a-cold-boot-of-the-guest"></a>게스트의 콜드 부팅 수행

앞의 세 단계를 완료한 후에 가상 컴퓨터를 콜드 부팅해야 새 프로세서 기능이 표시됩니다.  즉, 다시 시작하기 전에 실행 중인 VM 전원을 완전히 꺼야 합니다.  게스트 운영 체제에서 재부팅하는 것으로는 충분하지 않습니다.

## <a name="frequently-asked-questions"></a>질문과 대답

### <a name="how-does-this-impact-live-migration"></a>실시간 마이그레이션에 어떤 영향을 주나요?

새 프로세서 기능이 있는 가상 컴퓨터의 실시간 마이그레이션은 업데이트된 펌웨어가 없는 Hyper-V 호스트로의 이동 시 실패합니다.  업데이트된 펌웨어가 없는 호스트로 실시간 마이그레이션을 수행하려면 해당 게스트 가상 컴퓨터에서 업데이트된 프로세서 기능 제공을 중지하세요.  이를 수행하는 가장 쉬운 방법은 `MinVmVersionForCpuBasedMitigations`를 마이그레이션해야 하는 가상 컴퓨터 이상의 VM 버전으로 수정한 후 가상 컴퓨터를 콜드 부팅하는 것입니다.

새 프로세서 기능이 없는 가상 컴퓨터의 마이그레이션은 업데이트된 펌웨어가 있는 Hyper-V 호스트로의 이동 시 성공합니다.  그러나 업데이트된 펌웨어 기능을 보려면 이러한 게스트를 콜드 부팅해야 합니다.

최신 프로세서 패밀리 마이그레이션할 실패 Retpoline 사전 Skylake Intel 시스템에서 사용 하도록 구성 된 가상 컴퓨터 (즉, Skylake 이상).

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>Windows Server 2012R2와 Windows Server 2016 간의 버전 5.0 가상 컴퓨터 실시간 마이그레이션은 어떤가요?
이 시나리오를 성공하려면 Windows Server 2012R2 시스템과 Windows Server 2016 시스템 모두에 레지스트리 값을 설정해야 합니다.  Windows Server 2016으로 마이그레이션하면 VM 버전이 5.0으로 그대로 유지되므로 새 프로세서 기능을 가상 컴퓨터에 제공하려면 레지스트리 키가 필요합니다.  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>이 지침을 VMWare에서 실행되는 가상 컴퓨터에 적용하나요?
아니요, 이 지침은 Hyper-V 호스트에서 실행되는 가상 컴퓨터에만 해당됩니다.

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>이 지침은 Windows 10의 Hyper-V에 적용되나요?
예, Windows Server와 Client에서 실행되는 가상 컴퓨터에 동일한 단계가 적용됩니다.

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>가상 컴퓨터를 콜드 부팅하기 전에 펌웨어 업데이트를 설치해야 하나요?
예, 가상 컴퓨터를 콜드 부팅하기 전에 호스트 운영 체제와 펌웨어를 업데이트해야 합니다.

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>내 OEM에서 업데이트된 펌웨어를 아직 제공하지 않는 경우 어떻게 해야 하나요?
[투기적 실행 쪽 채널 취약성에 대한 Windows Server 2016 Hyper-V 호스트의 대체 보호](https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)을 확인하세요.

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>가상 컴퓨터의 VM 버전을 어떻게 확인하나요?
Hyper-V 호스트에서 다음 PowerShell을 실행하세요.
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>"프로세서 호환 모드"에서 실행되는 가상 컴퓨터를 보호하려면 다른 작업을 수행해야 하나요?
아니요.  이 페이지의 지침을 수행하면 새 프로세서 기능이 프로세서 호환 모드로 시작된 가상 컴퓨터에도 제공됩니다.

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>내 클러스터에 있는 컴퓨터 중 절반만 펌웨어 업데이트를 받은 경우 어떻게 되나요?
클러스터의 실시간 마이그레이션에 영향을 줍니다.  새 프로세서 기능이 있는 가상 컴퓨터는 펌웨어 업데이트가 없는 호스트로 실시간 마이그레이션을 수행할 수 없게 됩니다.  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>게스트 가상 컴퓨터가 새로운 프로세서 기능에 액세스할 수 있는지 여부를 어떻게 확인할 수 있나요?
"투기적 제어" PowerShell 모듈/스크립트를 사용하세요.  자세한 지침은 [이 페이지](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)를 참조하세요.

