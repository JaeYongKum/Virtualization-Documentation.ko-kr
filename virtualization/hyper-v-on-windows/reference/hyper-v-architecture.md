# <a name="hyper-v-architecture"></a>Hyper-V 아키텍처

Hyper-V는 특정 Windows x64 버전을 위한 하이퍼바이저 기반 가상화 기술입니다.  하이퍼바이저는 가상화의 핵심입니다.  격리된 여러 운영 체제가 단일 하드웨어 플랫폼을 공유할 수 있게 해주는 프로세서 관련 가상화 플랫폼입니다.

Hyper-V는 파티션의 측면에서 격리를 지원합니다. 파티션은 하이퍼바이저에서 지원하는 논리적 격리 단위로, 여기서 운영 체제가 실행됩니다. Microsoft 하이퍼바이저는 Windows에서 실행되는 부모 또는 루트 파티션이 하나 이상 있어야 합니다. 가상화 관리 스택이 부모 파티션에서 실행되어 하드웨어 디바이스에 직접 액세스합니다. 그 후 루트 파티션에서는 게스트 운영 체제를 호스트하는 자식 파티션을 만듭니다. 루트 파티션은 hypercall API(응용 프로그램 프로그래밍 인터페이스)를 사용하여 자식 파티션을 만듭니다.

파티션은 물리적 프로세서에 직접 액세스할 수 없고 프로세서 인터럽트도 처리할 수 없습니다. 그 대신 프로세서의 가상 보기를 갖고 있으며 각 게스트 파티션의 전용 가상 메모리 주소 지역에서 실행됩니다. 하이퍼바이저는 프로세서 인터럽트를 처리한 후 각 파티션으로 리디렉션합니다. 또한 Hyper-V는 CPU에서 사용하는 메모리 관리 하드웨어에 관계없이 작동하는 IOMMU(입출력 메모리 관리 장치)를 사용하여 다양한 게스트 가상 주소 공간 사이의 주소 변환을 가속화합니다. IOMMU는 실제 메모리 주소를 자식 파티션에서 사용하는 주소로 다시 매핑하는 데 사용됩니다.

또한 자식 파티션은 다른 하드웨어 리소스에 직접 액세스할 수 없으며 가상 디바이스(VDev)와 마찬가지로 리소스 가상 보기가 제공됩니다. 가상 디바이스에 대한 요청은 VMBus 또는 하이퍼바이저를 통해 요청을 처리하는 부모 파티션의 하이퍼바이저로 리디렉션됩니다. VMBus는 논리적 파티션 간 통신 채널입니다. 부모 파티션은 VMBus를 통해 통신하여 자식 파티션의 디바이스 액세스 요청을 처리하는 VSP(가상화 서비스 공급자)를 호스트합니다. 자식 파티션은 VMBus를 통해 디바이스 요청을 부모 파티션의 VSP로 리디렉션하는 VSC(가상화 서비스 소비자)를 호스트합니다. 이 전체 프로세스는 게스트 운영 체제에 대해 투명합니다.

또한 가상 디바이스는 인식 I/O라고 하는 Windows Server 가상화 기능을 저장소, 네트워킹, 그래픽 및 입력 하위 시스템에 활용할 수 있습니다. 인식 I/O는 모든 디바이스 에뮬레이션 계층을 무시하고 VMBus를 직접 활용하는 상위 수준 통신 프로토콜(예: SCSI)의 전문적인 가상화 인식 도구입니다. 따라서 통신의 효율성이 향상되지만 게스트가 하이퍼바이저와 VMBus에 대해 알고 있어야 합니다. Hyper-V 인식 I/O 및 하이퍼바이저 인식 커널은 Hyper-V 통합 서비스를 설치하면 함께 제공됩니다. VSC(가상 서버 클라이언트)를 포함하고 있는 통합 구성 요소는 다른 클라이언트 운영 체제에도 사용할 수 있습니다. Hyper-V를 사용하려면 Intel VT 또는 AMD-V(AMD 가상화) 기술과 함께 제공되는 하드웨어 지원 가상화가 포함된 프로세서가 필요합니다.

다음 다이어그램은 Hyper-V 환경의 아키텍처를 개략적으로 보여 줍니다.

![](./media/hv_architecture.png)

## <a name="support-for-third-party-virtualization-stacks"></a>타사 가상화 스택에 대한 지원

하이퍼바이저 수준에서 파티션을 만들고 관리하고, 파티션에 대한 메모리 매핑을 구성하고, 가상 프로세서 실행을 만들고 제어하기 위해 Hyper-V에는 또한 타사 가상화 스택 및 응용 프로그램용 확장된 사용자 모드 API가 있습니다.

> 예: QEMU 등의 클라이언트는 관리, 구성, 게스트/호스트 프로토콜 및 게스트 지원 드라이버를 유지하면서 하이퍼바이저를 실행할 수 있습니다. 모두 겹치지 않고 Hyper-V에서 관리되는 파티션과 함께 실행됩니다.

다음 다이어그램은 타사 아키텍처를 개략적으로 보여 줍니다.

![](./media/hv_platform_architecture_simplified.png)
> 자세한 내용은 [Windows 하이퍼바이저 플랫폼 API](./hypervisor-platform.md)를 참조하세요.
**참고: 이러한 API는 아직 공식 출시되지 않았으며 이후 Windows 릴리스에 포함됩니다.**

## <a name="glossary"></a>용어집
* **APIC** - 고급 프로그램 가능 인터럽트 컨트롤러 - 인터럽트 출력에 우선 순위 수준을 할당할 수 있는 디바이스입니다.
* **자식 파티션** - 게스트 운영 체제를 호스트하는 파티션 - 자식 컴퓨터의 실제 메모리 및 디바이스에 대한 모든 액세스는 VMBus(가상 컴퓨터 버스) 또는 하이퍼바이저를 통해 제공됩니다.
* **Hypercall** - 하이퍼바이저와 통신하기 위한 인터페이스 - hypercall 인터페이스는 하이퍼바이저에서 제공하는 최적화에 대한 액세스를 수용합니다.
* **하이퍼바이저** - 하드웨어와 하나 또는 여러 운영 사이에 위치하는 소프트웨어 계층입니다. 주요 작업은 파티션이라고 하는 격리된 실행 환경을 제공하는 것입니다. 하이퍼바이저는 기본 하드웨어에 대한 액세스를 제어 및 중재합니다.
* **IC** - 통합 구성 요소 - 자식 파티션이 다른 파티션 및 하이퍼바이저와 통신하게 해주는 구성 요소입니다.
* **I/O 스택** - I/O 스택
* **MSR** – 메모리 서비스 루틴
* **루트 파티션** - 부모 파티션이라고도 합니다.  디바이스 드라이버, 전원 관리, 디바이스 핫 추가/제거 등의 시스템 수준 기능을 관리합니다. 루트(또는 부모) 파티션은 실제 메모리 및 디바이스에 직접 액세스할 수 있는 유일한 파티션입니다.
* **VID** - 가상화 인프라 드라이버 - 파티션에 대한 파티션 관리 서비스, 가상 프로세서 관리 서비스 및 메모리 관리 서비스를 제공합니다.
* **VMBus** - 활성 가상화 파티션이 여러 개 있는 시스템에서 파티션 간 통신 및 디바이스 열거에 사용되는 채널 기반 통신 메커니즘입니다. VMBus는 Hyper-V 통합 서비스와 함께 설치됩니다.
* **VMMS** - 가상 컴퓨터 관리 서비스 - 자식 파티션에 있는 모든 가상 컴퓨터의 상태를 관리합니다.
* **VMWP** - 가상 컴퓨터 작업자 프로세스 - 가상화 스택의 사용자 모드 구성 요소입니다. 작업자 프로세스는 부모 파티션에 있는 Windows Server 2008 인스턴스의 가상 컴퓨터 관리 서비스를 자식 파티션의 게스트 운영 체제에 제공합니다. 가상 컴퓨터 관리 서비스는 실행되는 가상 컴퓨터마다 별도의 작업자 프로세스를 생성합니다.
* **VSC** - 가상화 서비스 클라이언트 - 자식 파티션에 상주하는 가상 디바이스입니다. VSC는 부모 파티션의 VSP(가상화 서비스 공급자)가 제공하는 하드웨어 리소스를 활용합니다. VMBus를 통해 부모 파티션의 해당 VSP와 통신하여 자식 파티션 디바이스 I/O 요청을 충족합니다.
* **VSP** - 가상화 서비스 공급자 - 루트 파티션에 상주하며 VMBus(가상 컴퓨터 버스)를 통해 자식 파티션에 가상 디바이스 지원을 제공합니다.
* **WinHv** - Windows 하이퍼바이저 인터페이스 라이브러리 - WinHv는 기본적으로 분할된 운영 체제의 드라이버와 드라이버가 표준 Windows 호출 규칙을 사용하여 하이퍼바이저를 호출할 수 있게 해주는 하이퍼바이저 사이의 브리지입니다.
* **WMI** - 가상 컴퓨터 관리 서비스는 가상 컴퓨터를 관리하고 제어하기 위한 WMI(Windows Management Instrumentation) 기반 API 집합을 노출합니다.
